---
slug: /How-Chaos-Mesh-Helps-Apache-APISIX-Improve-System-Stability
title: 'How Chaos Mesh Helps Apache APISIX Improve System Stability'
authors: shuyangwu
image: /img/blog/chaos-mesh-apisix.jpeg
tags: [Chaos Mesh, Chaos Engineering]
---

![Chaos MeshがApache APISIXのシステム安定性向上を支援](/img/blog/chaos-mesh-apisix.jpeg)

[Apache APISIX](https://github.com/apache/apisix)は、クラウドネイティブで高性能なスケーリング可能なマイクロサービスAPIゲートウェイです。Apache Software Foundationのトップレベルプロジェクトの一つであり、金融、インターネット、製造、小売、通信事業者など、世界中の数百社の企業において重要なトラフィックを処理しています。NASA、欧州連合のデジタルファクトリー、中国移動、Tencentなどが顧客として名を連ねています。

<!--truncate-->

コミュニティの成長に伴い、Apache APISIXの機能は外部コンポーネントとの相互作用がより頻繁になり、システムがより複雑化し、エラーの可能性も高まっています。潜在的なシステム障害を特定し、本番環境への信頼性を構築するため、私たちはカオスエンジニアリングの概念を導入しました。

![Apache APISIXアーキテクチャ](/img/blog/apache-apisix-architecture.jpg)

この記事では、[Chaos Mesh](https://chaos-mesh.org/)を使用してシステムの安定性を向上させた方法を共有します。

## 私たちの課題

Apache APISIXは1日に数百億のリクエストを処理しています。そのような規模において、ユーザーからいくつかの問題が報告されました：

- **シナリオ #1:** Apache APISIXの設定センターにおいて、etcdとApache APISIX間のネットワーク遅延が予期せず高くなった場合、Apache APISIXは依然としてトラフィックを正常にフィルタリングおよび転送できるか？
- **シナリオ #2:** etcdクラスター内のノードが故障し、クラスターが正常に動作を続けている場合でも、そのノードとApache APISIX管理APIとの相互作用でエラーが報告される。

Apache APISIXは、継続的インテグレーション（CI）においてユニットテスト、エンドツーエンド（E2E）テスト、ファジーテストを通じて多くのシナリオをカバーしていますが、外部コンポーネントとの相互作用シナリオはカバーされていません。システムが異常動作した場合、例えばネットワークの不安定、ハードディスクの故障、プロセスの強制終了などが発生した場合、Apache APISIXは適切なエラーメッセージを表示できるか？正常に動作を続けたり、正常な状態に復旧したりできるか？

## Chaos Meshを選んだ理由

これらのユーザーシナリオをテストし、製品が本番環境に投入される前に同様の問題を発見するため、私たちのコミュニティはChaos Meshを使用してカオステストを行うことを決定しました。

Chaos Meshは、クラウドネイティブなカオスエンジニアリングプラットフォームで、Kubernetes上での複雑なシステムに対する包括的な障害注入方法を特徴としています。Pod、ネットワーク、ファイルシステム、さらにはカーネルに至るまでの障害をカバーし、ユーザーがシステムの弱点を見つけ、本番環境での制御不能な状況に耐えられることを保証します。

Apache APISIXと同様に、Chaos Meshも活発なオープンソースコミュニティを持っています。活発なコミュニティは、ソフトウェアの安定した使用と迅速な反復を保証します。これがChaos Meshをさらに魅力的にしています。

## APISIXでのChaos Meshの使用方法

カオスエンジニアリングは単純な障害注入を超えて成長し、現在では完全な方法論を形成しています。カオス実験を作成するために、私たちはアプリケーションの正常な動作状態または「安定状態」を決定しました。その後、潜在的な問題を導入し、システムがどのように反応するかを観察しました。問題がアプリケーションを安定状態から外した場合、それらを修正しました。

ここでは、前述した2つのシナリオを取り上げ、Apache APISIXでChaos Meshをどのように使用しているかを説明します。

### シナリオ #1

以下の手順でカオスエンジニアリング実験を展開しました：

1. Apache APISIXが正常に動作しているかを測定するためのメトリクスを特定しました。テストにおいて最も重要な方法は、Grafanaを使用してApache APISIXの実行メトリクスを監視することです。CIではPrometheusからデータを抽出して比較を行いました。ここでは、評価指標としてルーティングおよび転送リクエスト数（RPS）とetcd接続性を使用しました。ログを分析し、Apache APISIXについてはNginxのエラーログを確認して、エラーが発生しているかどうか、またそのエラーが予期したものかどうかを判断しました。

2. 対照群でテストを実施しました。`create route`と`access route`の両方が成功し、etcdに接続できることを確認しました。RPSを記録しました。

3. ネットワークカオスを使用して5秒のネットワーク遅延を追加し、再度テストを行いました。今回は`set route`が失敗し、`get route`は成功、etcdには接続可能で、RPSは前回の実験と比べて大きな変化はありませんでした。この実験結果は我々の予想通りでした。

![etcdとApache APISIX間の高いネットワーク遅延発生](/img/blog/high-network-latency-between-etcd-and-apache-apisix.jpg)

### シナリオ #2

上記と同じ実験を対照群で実施した後、pod-killカオスを導入して予期したエラーを再現しました。etcdクラスタ内の少数のノードをランダムに削除した場合、APISIXがetcdに接続できる場合とできない場合があり、ログには大量の接続拒否エラーが記録されました。

etcdエンドポイントリストの1番目または3番目のノードを削除した場合、`set route`は正常に結果を返しました。しかし、リストの2番目のノードを削除した場合、`set route`は「connection refused」エラーを返しました。

調査の結果、Apache APISIXが使用するetcd Lua APIはエンドポイントをランダムではなく順番に選択していることが判明しました。そのため、etcdクライアントを作成すると、単一のetcdエンドポイントにバインドされてしまい、継続的な失敗が発生していました。

この問題を修正した後、etcd Lua APIにヘルスチェックを追加し、切断されたetcdノードに大量のリクエストが送信されないようにしました。また、ログがエラーで溢れないように、etcdクラスタが完全に切断された場合のフォールバックメカニズムも追加しました。

![etcdノード相互作用からのエラー報告](/img/blog/error-reported-from-etcd-node-interaction.jpg)

## 今後の計画

### E2Eシミュレーションシナリオでのカオステストの実施

Apache APISIXでは、システムの弱点を手動で特定してテストと修正を行っています。オープンソースコミュニティと同様に、CIでテストを実施しているため、Chaos Engineeringの失敗範囲が本番環境に与える影響を心配する必要はありません。しかし、このテストでは本番環境の複雑で包括的なアプリケーションシナリオを網羅できません。

より多くのシナリオをカバーするため、コミュニティでは既存のE2Eテストを使用してより完全なシナリオをシミュレートし、よりランダムで広範囲をカバーするカオステストを実施する計画です。

### 他のApache APISIXプロジェクトへのカオステストの追加

Apache APISIXのさらなる脆弱性発見に加えて、コミュニティではApache APISIX DashboardやApache APISIX Ingress Controllerなどの他のプロジェクトにもカオステストを追加する予定です。

### Chaos Meshへの機能追加

Chaos Meshをデプロイした際、一部の機能が一時的にサポートされていませんでした。例えば、サービスをネットワーク遅延のターゲットとして選択したり、コンテナポートを指定してネットワークカオスを注入したりすることができませんでした。今後、Apache APISIXコミュニティはChaos Meshに関連機能を追加するための支援を行います。

GitHubの[Apache APISIXプロジェクト](https://github.com/apache/apisix)へのコントリビューションを歓迎します。Chaos Meshに興味があり、改善したい方は、[Slackチャンネル](https://slack.cncf.io/)（#project-chaos-mesh）に参加するか、[GitHubリポジトリ](https://github.com/chaos-mesh/chaos-mesh)にプルリクエストやイシューを提出してください。
---
slug: /Securing-Online-Gaming-Combine-Chaos-Engineering-with-DevOps-Practices
title: 'Securing Online Gaming: Combine Chaos Engineering with DevOps Practices'
authors: zhaojunwu
image: /img/blog/chaos-mesh-tencent-ieg.jpeg
tags: [Chaos Mesh, Chaos Engineering, Use Cases]
---

![オンラインゲームのセキュリティ確保：カオスエンジニアリングとDevOpsプラクティスの融合](/img/blog/chaos-mesh-tencent-ieg.jpeg)

Interactive Entertainment Group（IEG）は、Tencent Holdingsの一部門であり、オンラインゲームやライブ配信などのデジタルコンテンツの開発に注力しています。最も人気のあるビデオゲームのパブリッシャーとしてよく知られています。

<!--truncate-->

この記事では、なぜそしてどのようにして私たちがDevOpsプロセスにカオスエンジニアリングを導入したのかを説明します。

私たちは毎日、合計1000万以上の訪問を処理し、ピーク時には1秒あたり100万以上のクエリ（QPS）を処理しています。プレイヤーに楽しく魅力的な体験を提供するために、さまざまな日次または季節ごとのゲームイベントを開催しています。時には、1日に500回以上イベントコードを更新する必要があります。ユーザーベースが拡大するにつれ、データの総量も急速に増加しています。現在、その量は200テラバイトに達しています。私たちは、膨大なユーザークエリと迅速なリリースイテレーションを管理し、それをうまくこなしています。

クラウドネイティブのDevOpsソリューションにより、イベントオペレーターは増え続けるオンラインイベントから解放されました。私たちは、コードの記述から本番環境でのイベントの立ち上げまで、彼らが必要とするすべてを処理するパイプラインを開発しました。新しいイベントコードが検出されると、オペレーションプラットフォームは自動的にそれらからイメージをビルドし、Tencent Kubernetes Engine（TKE）にデプロイします。この自動化されたプロセス全体にかかる時間は、わずか5分です。

現在、IEGのほぼすべてのオペレーションサービスはTKEで実行されています。クラウドネイティブ技術のおかげで、エラスティックスケーリングにより、クラウドサービスの迅速な拡張と縮小が可能になりました。

さらに、私たちはイテレーションをより簡単にすることを期待しています。ベストプラクティスは、大きくて保守が難しいサービスを、独立して保守できる多くの「小さな」サービスに分割することです。「小さな」サービスはコード量が少なく、ロジックが単純で、引き継ぎやトレーニングのコストが低くなります。私たち開発者は、DevOpsイニシアチブの一環として、この種のマイクロサービスアーキテクチャを実践し続けています。しかし、同様の問題が残っています。サービスの数が増えるにつれ、それらの間の呼び出しの複雑さも増します。**さらに悪いことに、1つの「小さな」サービスが失敗すると、すべてのサービスをダウンさせる連鎖反応を引き起こす可能性があります—マイクロサービスの依存地獄です。**

問題は、サービスのフォールトトレランスが異なることです。ダウングレードをサポートするものもあれば、そうでないものもあります。タイムリーなアラートを提供できないサービスや、効果的なデバッグツールがないサービスもあります。その結果、サービスのデバッグは、私たちの日常業務においてますます厄介で緊急の課題となっています。

しかし、それを放置することはできません。不安定なパフォーマンスが常にプレイヤーを遠ざけるとしたらどうでしょうか？壊滅的な障害が発生したらどうなるでしょうか？

## 障害を起こさせよう

Netflixはカオスエンジニアリングのアイデアを導入しました。このアプローチは、非本番環境で障害を注入することで、システムのレジリエンスをあらゆるエッジケースに対してテストし、理想的なシステム信頼性を達成します。Gartnerの記事によると、2023年までに、組織の40％がDevOpsの主要な目標を達成するためにカオスエンジニアリングを使用し、計画外のダウンタイムを20％削減するとされています。

これが、私たちが最悪のシナリオを回避する方法です。私の意見では、障害注入は現在、すべての技術チームが必ず行うべきことです。初期のテストケースでは、開発者はサービスを起動する前にノードをダウンさせ、プライマリノードがセカンダリノードに自動的に切り替わるかどうか、ディザスタリカバリが機能するかどうかを確認していました。

**しかし、カオスエンジニアリングは障害注入以上のものです。** これは、新しい技術、専門的なテストツール、そして確固たる理論を常に推進する分野です。それが私たちが探求を続ける理由です。

IEGは1年以上前に正式にカオスエンジニアリングプロジェクトを開始しました。私たちは最初から正しくやりたいと考えていました。鍵は、Kubernetes環境で実験を実行することをサポートするカオスエンジニアリングツールを選択することです。**慎重に比較した結果、[Chaos Mesh](https://github.com/chaos-mesh/chaos-mesh)が最適な選択肢であると確信しました**。その理由は次のとおりです：

- Cloud Native Computing Foundation（CNCF）のサンドボックスプロジェクトであり、友好的で生産的なコミュニティを有しています。
- 既存のアプリケーションに侵入しません。
- Web UIと多様な障害注入タイプを提供します。以下の画像でその様子をご覧いただけます。

![カオスエンジニアリングツールの比較](/img/blog/comparison-of-chaos-engineering-tools.png)

> 注: この比較は古いものであり、Chaos Meshがサポートする障害注入機能を他の有名なカオスエンジニアリングプラットフォームと比較する目的で掲載しています。特定のプロジェクトを優遇または位置づける意図はありません。修正点があれば歓迎します。

## カオステストプラットフォームの構築

当社のカオスエンジニアリングチームは、Chaos Meshを継続的インテグレーションおよび継続的デリバリーパイプラインに組み込みました。以下の図に示すように、Chaos Meshは現在、当社の運用プラットフォームで重要な役割を果たしています。Chaos MeshのダッシュボードAPIを使用して、カオス実験の作成、実行、削除を行い、自社プラットフォーム上で監視しています。Pod、コンテナ、ネットワーク、IOにおける基本的なシステムレベルの障害をシミュレートできます。

![IEGの運用プラットフォームに組み込まれたChaos Mesh](/img/blog/chaos-mesh-embedded-in-IEG's-operation-platform.png)

IEGでは、**カオスエンジニアリングは一般的に、いくつかの重要なフェーズを含む閉ループとして要約されます**:

- システム全体のレジリエンスを向上させる。

  必要に応じて変更可能なカオステストプラットフォームを構築する。

- テスト計画を設計する。

  テスト計画には、ターゲット、範囲、注入する障害、監視メトリクスなどを明記する必要があります。テストが適切に制御されていることを確認します。

- カオス実験を実行し、結果をレビューする。

  カオス実験前後のシステムパフォーマンスを比較します。

- 発生した問題を解決する。

  見つかった問題を修正し、次の実験に向けてシステムをアップグレードします。

- カオス実験を繰り返し、パフォーマンスを検証する。

  カオス実験を繰り返し、システムのパフォーマンスが期待通りかどうかを確認します。期待通りであれば、別のテスト計画を設計します。

![IEGにおけるカオスエンジニアリングの5つのフェーズ](/img/blog/five-phases-of-chaos-engineering-in-IEG.png)

例えば、**高CPU使用率下でのサービスのパフォーマンスを頻繁にテスト**しています。まず、実験をオーケストレーションし、スケジュールします。その後、実験を実行し、関連サービスのパフォーマンスを監視します。QPS、レイテンシ、レスポンス成功率などの複数の監視メトリクスが、運用プラットフォームを通じて即座に可視化されます。プラットフォームはレビュー用のレポートを生成するため、これらの実験が期待通りだったかどうかを確認できます。

## ユースケース

以下に、DevOpsワークフローでカオスエンジニアリングを活用する方法のいくつかの例を紹介します。

### より細かい粒度の障害注入

ゲームがプレイヤーに利用可能かどうかを確認するために、システム全体をシャットダウンする必要はありません。時には、単一のゲームアカウントにネットワーク遅延などの障害を注入し、その応答を観察したい場合があります。ゲートウェイでトラフィックをハイジャックし、実験を実行することで、このような細かい粒度を実現できるようになりました。

### レッドチーミング

当然ながら、チームメンバーは定期的なカオス実験に飽きてしまいました。結局のところ、それは左手と右手を戦わせるようなものです。IEGでは、**システムのレジリエンスを有機的に向上させるために、レッドチーミングと呼ばれるテストプラクティスをカオスエンジニアリングに統合しています。** レッドチーミングはペネトレーションテストに似ていますが、よりターゲットを絞ったものです。外部者の視点から実際の攻撃を模倣するために、テスト担当者のグループが必要です。もし私がIT運用を担当しているなら、特定のサービスに障害をシミュレートし、開発者の同僚がうまく対応しているかどうかを確認します。潜在的な障害が見つかった場合、いわゆる「厳しい話」に備えてください。一方、開発者は積極的にカオス実験を行い、非難されないようにリスクを残さないようにします。

![IEGにおけるレッドチーミングのプロセス](/img/blog/red-teaming-process-in-IEG.png)

### 依存関係分析

マイクロサービスにおける依存関係の管理は重要です。私たちのケースでは、非コアサービスがコアサービスのボトルネックになってはなりません。幸い、カオスエンジニアリングを活用することで、呼び出されるサービスに障害を注入し、メインサービスがどの程度影響を受けるかを観察するだけで依存関係分析を実施できます。結果に基づいて、特定のシナリオにおけるサービス呼び出しチェーンを最適化できます。

### 自動化された障害検出と診断

また、AIボットを活用した障害検出と診断の仕組みも検討中です。サービスが複雑化するほど、障害発生の可能性も高まります。**私たちの目標は、本番環境やその他の制御された環境で大規模なカオス実験を実施し、障害検出モデルをトレーニングすることです。**

## カオスエンジニアリングがDevOpsプラクティスを強化

現在、週平均50人以上がカオス実験を実施し、150回以上のテストを行い、合計100件以上の問題を検出しています。

手書きのスクリプトで障害注入を行う時代は終わりました。これは慣れていない人にとって難しい作業でした。**カオスエンジニアリングとDevOpsプラクティスを組み合わせる利点は明らかです：数分でさまざまな障害タイプをドラッグ＆ドロップでオーケストレーションし、ワンクリックで実行し、結果をリアルタイムで監視できます——すべてが1つのプラットフォームで完結します。**

![DevOpsと連携したカオスエンジニアリングで効率的な障害注入を実現](/img/blog/chaos-engineering-with-devops.png)

機能豊富なカオスエンジニアリングツールと合理化されたDevOpsプロセスにより、IEGでは過去6ヶ月間で障害注入とカオスベースの最適化の効率が少なくとも10倍向上したと推定しています。ビジネスへのカオスエンジニアリング導入に不安がある場合、私たちの経験が少しでも参考になれば幸いです。